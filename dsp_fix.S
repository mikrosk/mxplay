/*
 * dsp_fix.s -- custom Dsp_ExecProg
 *
 * Copyright (c) 2005 Miro Kropacek; miro.kropacek@gmail.com
 * Copyright (c) 1998 NoCrew Laboratories.
 * 
 * This file is part of the mxPlay project, multiformat audio player for
 * Atari TT/Falcon computers.
 *
 * mxPlay is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * mxPlay is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with mxPlay; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
 */

/*
 * Implements:
 * 
 *     extern Int dsp_load_program(Byte *program, Int length);
 * 
 * Where length is the number of DSP words (e.i. 3 byte tuples).
 * A return value of 1 means that the loading was sucessful. 0
 * means something went wrong.
 * 
 * This module will always load the DSP program. It is compatible
 * with the Dsp_ExecProg loader. However, as it reloads the DSP
 * bootstrap code every time -- which the TOS version does not --
 * this one does not freeze up.
 */
		.globl	_dsp_load_program

		.text
		
_dsp_load_program:
		move.l	a0,dsp_program
		move.l	d0,dsp_length

		move	sr,d0				|Test for supervisor mode.
		btst	#13,d0
		bne.b	.dsp_load
	
		move.l	#.dsp_load,-(sp)
		move.w	#0x26,-(sp)
		trap	#14
		addq.w	#6,sp

		move.l	dsp_status,d0
		rts

.dsp_load:	bsr	.dsp_reset
		bsr	.dsp_go
		move.l	d0,dsp_status
		rts

.dsp_reset:	move.b	#0xe,0xffff8800.w		|Power down.
		move.b	0xffff8800.w,d0
		and.b	#0xef,d0
		move.b	d0,0xffff8802.w
		or.b	#0x10,d0
		move.b	d0,0xffff8802.w
		
		move.w	#10000-1,d0			|Wait for DSP to power down.
.wait:		nop
		dbra	d0,.wait

		move.b	#0xe,0xffff8800.w		|Power up.
		move.b	0xffff8800.w,d0
		and.b	#0xef,d0
		move.b	d0,0xffff8802.w
		rts

.dsp_go:	lea	dsp_bootstrap_code,a0		|Load system startup code.
		move.w	#512-1,d0
.next:		btst.b	#1,0xffffa202.w
		beq.s	.next
		move.b	(a0)+,0xffffa205.w
		move.b	(a0)+,0xffffa206.w
		move.b	(a0)+,0xffffa207.w
		dbra	d0,.next

		move.l	dsp_program,a0			|Load DSP binary.
		move.l	dsp_length,d0
		subq.w	#1,d0
		bmi.s	.no_way
.copy:		btst.b	#1,0xffffa202.w
		beq.s	.copy
		move.b	(a0)+,0xffffa205.w
		move.b	(a0)+,0xffffa206.w
		move.b	(a0)+,0xffffa207.w
		dbra	d0,.copy

.go:		btst.b	#1,0xffffa202.w			|Launch DSP binary.
		beq.s	.go
		move.l	#3,0xffffa204.w
		
		moveq	#1,d0
		rts
.no_way:	moveq	#0,d0
		rts


		.data
		
dsp_bootstrap_code:
		dc.b	0x0c,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x60,0xf4,0x00,0x00,0x00,0x4f,0x61,0xf4
		dc.b	0x00,0x00,0x7e,0xa9,0x06,0x2e,0x80,0x00,0x00,0x47
		dc.b	0x07,0xd8,0x84,0x07,0x59,0x84,0x08,0xf4,0xa8,0x00
		dc.b	0x00,0x04,0x08,0xf4,0xbf,0x00,0x0c,0x00,0x00,0xfe
		dc.b	0xb8,0x0a,0xf0,0x80,0x00,0x7e,0xa9,0x08,0xf4,0xa0
		dc.b	0x00,0x00,0x01,0x08,0xf4,0xbe,0x00,0x00,0x00,0x0a
		dc.b	0xa9,0x80,0x00,0x7e,0xad,0x08,0x4e,0x2b,0x44,0xf4
		dc.b	0x00,0x00,0x00,0x03,0x44,0xf4,0x45,0x00,0x00,0x01
		dc.b	0x0e,0xa0,0x00,0x0a,0xa9,0x80,0x00,0x7e,0xb5,0x08
		dc.b	0x50,0x2b,0x0a,0xa9,0x80,0x00,0x7e,0xb8,0x08,0x46
		dc.b	0x2b,0x44,0xf4,0x45,0x00,0x00,0x02,0x0a,0xf0,0xaa
		dc.b	0x00,0x7e,0xc9,0x20,0x00,0x45,0x0a,0xf0,0xaa,0x00
		dc.b	0x7e,0xd0,0x06,0xc6,0x00,0x00,0x7e,0xc6,0x0a,0xa9
		dc.b	0x80,0x00,0x7e,0xc4,0x08,0x58,0x6b,0x0a,0xf0,0x80
		dc.b	0x00,0x7e,0xad,0x06,0xc6,0x00,0x00,0x7e,0xcd,0x0a
		dc.b	0xa9,0x80,0x00,0x7e,0xcb,0x08,0x58,0xab,0x0a,0xf0
		dc.b	0x80,0x00,0x7e,0xad,0x06,0xc6,0x00,0x00,0x7e,0xd4
		dc.b	0x0a,0xa9,0x80,0x00,0x7e,0xd2,0x08,0x58,0xeb,0x0a
		dc.b	0xf0,0x80,0x00,0x7e,0xad,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
		dc.b	0x00,0x00,0x00,0x00,0x00,0x00
		
		.bss
		
dsp_program:	ds.l	1
dsp_length:	ds.l	1
dsp_status:	ds.l	1

		.text
